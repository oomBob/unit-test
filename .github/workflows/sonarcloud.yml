name: SonarCloud Analysis

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests and Generate Coverage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        env:
          XDEBUG_MODE: coverage
        with:
          php-version: '8.0'
          extensions: mbstring, xml, dom, curl, libxml, iconv, zip
          coverage: xdebug

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-progress --no-interaction --optimize-autoloader

      - name: Test Xdebug Coverage Generation
        env:
          XDEBUG_MODE: coverage
        run: |
          echo "=== Testing Xdebug Coverage ==="
          php -r "
            if (!extension_loaded('xdebug')) {
              echo 'ERROR: Xdebug is NOT loaded!' . PHP_EOL;
              exit(1);
            }
            echo '✅ Xdebug version: ' . phpversion('xdebug') . PHP_EOL;
            echo '✅ XDEBUG_MODE: ' . (getenv('XDEBUG_MODE') ?: 'not set') . PHP_EOL;
          " || exit 1
          echo ""

      - name: Verify Xdebug is enabled
        env:
          XDEBUG_MODE: coverage
        run: |
          echo "Checking PHP version:"
          php -v
          echo ""
          echo "Checking Xdebug:"
          php -m | grep -i xdebug || echo "Xdebug not found in modules"
          echo ""
          echo "Xdebug configuration:"
          php -i | grep -i xdebug | head -10 || echo "No Xdebug info found"
          echo ""
          echo "Checking if Xdebug mode is set:"
          echo "XDEBUG_MODE=${XDEBUG_MODE:-not set}"
          echo ""
          echo "Testing Xdebug extension:"
          php -r "echo 'Xdebug extension loaded: ' . (extension_loaded('xdebug') ? 'YES' : 'NO') . PHP_EOL;"
          php -r "if (extension_loaded('xdebug')) { echo 'Xdebug version: ' . phpversion('xdebug') . PHP_EOL; } else { echo 'ERROR: Xdebug is NOT loaded!' . PHP_EOL; exit(1); }"

      - name: Run PHPUnit tests with coverage
        env:
          XDEBUG_MODE: coverage
        run: |
          echo "Running PHPUnit with coverage..."
          echo "XDEBUG_MODE is set to: $XDEBUG_MODE"
          php -r "echo 'Xdebug loaded: ' . (extension_loaded('xdebug') ? 'YES' : 'NO') . PHP_EOL;"
          echo ""
          echo "Running PHPUnit tests with coverage generation..."
          # Run PHPUnit with coverage-clover to generate coverage.xml for SonarCloud
          php -d display_errors=0 -d display_startup_errors=0 -d html_errors=0 -d log_errors=1 vendor/bin/phpunit --coverage-clover=coverage.xml --log-junit=phpunit-report.xml
          PHPUNIT_EXIT_CODE=$?
          echo ""
          echo "=== PHPUnit Exit Code: $PHPUNIT_EXIT_CODE ==="
          echo ""
          echo "=== Checking for coverage.xml ==="
          if [ -f coverage.xml ]; then
            echo "✅ coverage.xml exists!"
            echo "File size: $(wc -l < coverage.xml) lines"
            echo "First 20 lines:"
            head -20 coverage.xml
            echo ""
            echo "✅ Coverage file successfully generated for SonarCloud"
          else
            echo "❌ coverage.xml NOT found!"
            exit 1
          fi

      - name: Verify coverage file exists
        run: |
          echo "Checking for coverage.xml file..."
          if [ ! -f coverage.xml ]; then
            echo "❌ ERROR: coverage.xml file not found!"
            echo ""
            echo "Current directory contents:"
            ls -la
            echo ""
            echo "Possible reasons:"
            echo "1. Tests didn't run successfully"
            echo "2. Xdebug is not properly configured"
            echo "3. PHPUnit didn't generate coverage"
            echo ""
            echo "Checking for any XML files:"
            ls -la *.xml 2>/dev/null || echo "No XML files found"
            exit 1
          fi
          echo "✅ Coverage file found:"
          ls -lh coverage.xml
          echo ""
          echo "File size:"
          wc -l coverage.xml
          echo ""
          echo "Checking if coverage.xml contains valid data:"
          if grep -q "project timestamp" coverage.xml || grep -q "<coverage" coverage.xml; then
            echo "✅ Coverage file contains project data"
          else
            echo "⚠️ Coverage file might be empty or invalid"
            echo "First 50 lines of coverage.xml:"
            head -50 coverage.xml
          fi
          echo ""
          echo "Sample of file paths in coverage.xml:"
          grep -o 'file.*path="[^"]*"' coverage.xml | head -5 || echo "No file paths found"
          
      - name: Verify sonar-project.properties
        run: |
          echo "Checking sonar-project.properties configuration:"
          cat sonar-project.properties
          echo ""
          echo "Verifying coverage path is configured:"
          if grep -q "sonar.php.coverage.reportPaths" sonar-project.properties; then
            echo "✓ Coverage report path is configured"
            grep "sonar.php.coverage.reportPaths" sonar-project.properties
          else
            echo "✗ Coverage report path is NOT configured!"
            exit 1
          fi

      - name: Show coverage file before scan
        run: |
          echo "Verifying coverage.xml exists before SonarCloud scan:"
          ls -la coverage.xml
          echo ""
          echo "File content preview (first 30 lines):"
          head -30 coverage.xml
          echo ""
          echo "Verifying coverage file format (should be Clover XML):"
          if grep -q '<?xml' coverage.xml && grep -q '<coverage' coverage.xml; then
            echo "✅ Coverage file is valid Clover XML format"
          else
            echo "❌ Coverage file format is invalid"
            exit 1
          fi
          echo ""
          echo "Checking sonar-project.properties coverage path:"
          grep "sonar.php.coverage.reportPaths" sonar-project.properties || echo "❌ Coverage path not configured"

      - name: Verify SonarCloud Token Configuration
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          if [ -z "$SONAR_TOKEN" ]; then
            echo "❌ ERROR: SONAR_TOKEN secret is not set!"
            echo ""
            echo "Please add the SONAR_TOKEN secret in GitHub repository settings:"
            echo "1. Go to: Settings → Secrets and variables → Actions"
            echo "2. Click: New repository secret"
            echo "3. Name: SONAR_TOKEN"
            echo "4. Value: (paste your SonarCloud token from My Account → Security)"
            echo "5. Click: Add secret"
            exit 1
          fi
          echo "✅ SONAR_TOKEN secret is configured"
          TOKEN_LEN=${#SONAR_TOKEN}
          echo "Token length: $TOKEN_LEN characters"
          # SonarCloud tokens are typically 40+ characters
          if [ "$TOKEN_LEN" -lt 20 ]; then
            echo "⚠️ WARNING: Token seems too short (expected 40+ characters)"
            echo "   This might indicate an incorrect token format"
          else
            echo "✅ Token length looks correct"
          fi

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: ${{ github.workspace }}
        continue-on-error: false

      - name: Workflow Summary
        if: always()
        run: |
          echo "=== SonarCloud Workflow Summary ==="
          echo ""
          echo "✅ If you see this message, all workflow steps completed"
          echo ""
          echo "Next steps:"
          echo "1. Check SonarCloud dashboard: https://sonarcloud.io"
          echo "2. Navigate to your project: oomBob_unit-test"
          echo "3. Review Quality Gate status"
          echo ""
          echo "⚠️  Important: Quality Gate may show as 'Failed' even if scan succeeded"
          echo "   This is due to security hotspots requirement (needs 100% review)"
          echo "   To fix this, see instructions in sonar-project.properties"
          echo ""
          echo "Common workflow failure causes:"
          echo "- Invalid SONAR_TOKEN (generate new token in SonarCloud)"
          echo "- Project key mismatch (check sonar-project.properties)"
          echo "- Organization access issues (verify token permissions)"

