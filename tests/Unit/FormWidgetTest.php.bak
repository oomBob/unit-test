<?php
/**
 * Tests for Form Widget
 *
 * @package HelloElementorChild\Tests\Unit
 */

namespace HelloElementorChild\Tests\Unit;

use PHPUnit\Framework\TestCase;
use Brain\Monkey;
use Mockery;

/**
 * Class FormWidgetTest
 */
class FormWidgetTest extends TestCase
{
    private $widget;
    private $mockRepeater;
    private $mockIconsManager;

    /**
     * Set up test environment
     */
    protected function setUp(): void
    {
        parent::setUp();
        Monkey\setUp();
        
        // Mock WordPress functions
        Monkey\Functions\when('add_action')->justReturn();
        Monkey\Functions\when('__')->returnArg();
        Monkey\Functions\when('esc_html__')->returnArg();
        Monkey\Functions\when('esc_html')->returnArg();
        Monkey\Functions\when('esc_attr')->returnArg();
        Monkey\Functions\when('esc_url')->returnArg();
        Monkey\Functions\when('esc_js')->returnArg();
        Monkey\Functions\when('wp_create_nonce')->justReturn('test-nonce');
        Monkey\Functions\when('get_the_ID')->justReturn(123);
        Monkey\Functions\when('admin_url')->justReturn('https://example.com/wp-admin/');
        Monkey\Functions\when('is_rtl')->justReturn(false);
        Monkey\Functions\when('wp_generate_password')->justReturn('abc123');
        
        // Define ABSPATH constant if not defined
        if (!defined('ABSPATH')) {
            define('ABSPATH', '/fake/abspath/');
        }

        // Create mock Elementor base classes
        $this->createElementorMocks();
    }

    /**
     * Create mock Elementor classes
     */
    private function createElementorMocks()
    {
        // Mock Elementor\Controls_Manager
        if (!class_exists('\Elementor\Controls_Manager')) {
            eval('
            namespace Elementor {
                class Controls_Manager {
                    const TEXT = "text";
                    const TEXTAREA = "textarea";
                    const SELECT = "select";
                    const SELECT2 = "select2";
                    const NUMBER = "number";
                    const SWITCHER = "switcher";
                    const REPEATER = "repeater";
                    const HIDDEN = "hidden";
                    const URL = "url";
                    const ICONS = "icons";
                    const CHOOSE = "choose";
                    const SLIDER = "slider";
                    const DIMENSIONS = "dimensions";
                    const COLOR = "color";
                    const HEADING = "heading";
                    const HOVER_ANIMATION = "hover_animation";
                    const NOTICE = "notice";
                    const TAB_CONTENT = "tab_content";
                    const TAB_STYLE = "tab_style";
                }
            }
            ');
        }

        // Mock Widget_Base
        if (!class_exists('\Elementor\Widget_Base')) {
            eval('
            namespace Elementor {
                class Widget_Base {
                    protected $settings = [];
                    protected $id = "test_id_123";
                    protected $render_attributes = [];
                    
                    public function get_id() {
                        return $this->id;
                    }
                    
                    public function start_controls_section($id, $args = []) {}
                    public function end_controls_section() {}
                    public function add_control($id, $args = []) {}
                    public function add_responsive_control($id, $args = []) {}
                    public function add_group_control($group, $args = []) {}
                    public function start_controls_tabs($id) {}
                    public function end_controls_tabs() {}
                    public function start_controls_tab($id, $args = []) {}
                    public function end_controls_tab() {}
                    
                    public function get_settings_for_display() {
                        return $this->settings;
                    }
                    
                    public function set_settings($settings) {
                        $this->settings = $settings;
                    }
                    
                    public function add_render_attribute($element, $key, $value = null) {
                        if (is_array($key)) {
                            foreach ($key as $attr => $val) {
                                $this->render_attributes[$element][$attr] = $val;
                            }
                        } else {
                            $this->render_attributes[$element][$key] = $value;
                        }
                    }
                    
                    public function print_render_attribute_string($element) {
                        if (!isset($this->render_attributes[$element])) return;
                        foreach ($this->render_attributes[$element] as $attr => $value) {
                            if (is_array($value)) {
                                $value = implode(" ", $value);
                            }
                            echo $attr . \'="\' . $value . \'" \';
                        }
                    }
                    
                    public function print_unescaped_setting($key) {
                        echo $this->settings[$key] ?? "";
                    }
                }
            }
            ');
        }

        // Mock Elementor\Repeater
        if (!class_exists('\Elementor\Repeater')) {
            eval('
            namespace Elementor {
                class Repeater {
                    private $controls = [];
                    
                    public function start_controls_tabs($id) {}
                    public function end_controls_tabs() {}
                    public function start_controls_tab($id, $args = []) {}
                    public function end_controls_tab() {}
                    public function add_control($id, $args = []) {
                        $this->controls[$id] = $args;
                    }
                    public function add_responsive_control($id, $args = []) {
                        $this->controls[$id] = $args;
                    }
                    public function get_controls() {
                        return $this->controls;
                    }
                }
            }
            ');
        }

        // Mock Group Controls
        if (!class_exists('\Elementor\Group_Control_Typography')) {
            eval('
            namespace Elementor {
                class Group_Control_Typography {
                    public static function get_type() {
                        return "typography";
                    }
                }
                class Group_Control_Border {
                    public static function get_type() {
                        return "border";
                    }
                }
            }
            ');
        }

        // Mock Icons_Manager
        if (!class_exists('\Elementor\Icons_Manager')) {
            eval('
            namespace Elementor {
                class Icons_Manager {
                    public static function render_icon($icon, $attributes = []) {
                        echo "<i class=\"test-icon\"></i>";
                    }
                }
            }
            ');
        }

        // Mock Core\Kits namespace
        if (!class_exists('\Elementor\Core\Kits\Documents\Tabs\Global_Colors')) {
            eval('
            namespace Elementor\Core\Kits\Documents\Tabs {
                class Global_Colors {
                    const COLOR_PRIMARY = "primary";
                    const COLOR_SECONDARY = "secondary";
                    const COLOR_TEXT = "text";
                    const COLOR_ACCENT = "accent";
                }
                class Global_Typography {
                    const TYPOGRAPHY_PRIMARY = "primary";
                    const TYPOGRAPHY_SECONDARY = "secondary";
                    const TYPOGRAPHY_TEXT = "text";
                    const TYPOGRAPHY_ACCENT = "accent";
                }
            }
            ');
        }

        // Mock ElementorPro\Plugin
        if (!class_exists('\ElementorPro\Plugin')) {
            eval('
            namespace ElementorPro {
                class Plugin {
                    private static $instance = null;
                    public $documents = null;
                    
                    public static function elementor() {
                        if (self::$instance === null) {
                            self::$instance = new self();
                        }
                        return self::$instance;
                    }
                }
            }
            ');
        }

        // Mock Elementor\Plugin
        if (!class_exists('\Elementor\Plugin')) {
            eval('
            namespace Elementor {
                class Plugin {
                    private static $instance = null;
                    public $widgets_manager = null;
                    
                    public static function instance() {
                        if (self::$instance === null) {
                            self::$instance = new self();
                            $manager = new \stdClass();
                            $manager->register_widget_type = new class {
                                public function __invoke($widget) {
                                    return true;
                                }
                            };
                            
                            // Create a wrapper object that can handle method calls
                            self::$instance->widgets_manager = new class {
                                public function register_widget_type($widget) {
                                    return true;
                                }
                            };
                        }
                        return self::$instance;
                    }
                }
            }
            ');
        }
    }

    /**
     * Tear down test environment
     */
    protected function tearDown(): void
    {
        Monkey\tearDown();
        Mockery::close();
        parent::tearDown();
    }

    /**
     * Load the widget file and get the widget class
     */
    private function loadWidget()
    {
        static $loaded = false;
        
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file) && !$loaded) {
            require_once $file;
            $loaded = true;
            
            // Call the registration function
            if (function_exists('register_oom_form_widget')) {
                register_oom_form_widget();
            }
        }
        
        if (class_exists('OOm_Form_Widget')) {
            return new \OOm_Form_Widget();
        }
        return null;
    }

    /**
     * Invoke protected/private methods using Reflection
     */
    private function invokeMethod($object, $methodName, array $parameters = [])
    {
        $reflection = new \ReflectionClass(get_class($object));
        $method = $reflection->getMethod($methodName);
        $method->setAccessible(true);

        return $method->invokeArgs($object, $parameters);
    }

    /**
     * Test register_oom_form_widget function exists
     */
    public function test_register_oom_form_widget_function_exists()
    {
        $widget = $this->loadWidget(); // This loads the file safely
        
        $this->assertTrue(function_exists('register_oom_form_widget'));
    }

    /**
     * Test widget class can be instantiated
     */
    public function test_widget_can_be_instantiated()
    {
        $widget = $this->loadWidget();
        $this->assertNotNull($widget);
        $this->assertInstanceOf('\OOm_Form_Widget', $widget);
    }

    /**
     * Test get_name method
     */
    public function test_get_name_returns_correct_value()
    {
        $widget = $this->loadWidget();
        if ($widget) {
            $name = $widget->get_name();
            $this->assertEquals('oom-elementor-form', $name);
        } else {
            $this->markTestSkipped('Widget could not be loaded');
        }
    }

    /**
     * Test get_title method
     */
    public function test_get_title_returns_correct_value()
    {
        $widget = $this->loadWidget();
        if ($widget) {
            $title = $widget->get_title();
            $this->assertEquals('OOm Form', $title);
        } else {
            $this->markTestSkipped('Widget could not be loaded');
        }
    }

    /**
     * Test get_icon method
     */
    public function test_get_icon_returns_correct_value()
    {
        $widget = $this->loadWidget();
        if ($widget) {
            $icon = $widget->get_icon();
            $this->assertEquals('eicon-form-horizontal', $icon);
        } else {
            $this->markTestSkipped('Widget could not be loaded');
        }
    }

    /**
     * Test get_categories method
     */
    public function test_get_categories_returns_array()
    {
        $widget = $this->loadWidget();
        if ($widget) {
            $categories = $widget->get_categories();
            $this->assertIsArray($categories);
            $this->assertContains('basic', $categories);
        } else {
            $this->markTestSkipped('Widget could not be loaded');
        }
    }

    /**
     * Test get_current_post_id with no Elementor document
     */
    public function test_get_current_post_id_returns_post_id()
    {
        $widget = $this->loadWidget();
        if ($widget && method_exists($widget, 'get_current_post_id')) {
            $postId = $widget->get_current_post_id();
            $this->assertEquals(123, $postId);
        } else {
            $this->markTestSkipped('Widget or method not available');
        }
    }

    /**
     * Test widget file structure contains widget name
     */
    public function test_widget_file_contains_widget_name()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            $this->assertStringContainsString('oom-elementor-form', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains all field types
     */
    public function test_widget_file_contains_all_field_types()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $fieldTypes = ['text', 'email', 'textarea', 'url', 'tel', 'radio', 
                          'select', 'checkbox', 'acceptance', 'number', 'date', 
                          'time', 'password', 'html', 'hidden'];
            
            foreach ($fieldTypes as $type) {
                $this->assertStringContainsString($type, $content);
            }
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains email configuration
     */
    public function test_widget_file_contains_email_configuration()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('email_to', $content);
            $this->assertStringContainsString('email_subject', $content);
            $this->assertStringContainsString('email_message', $content);
            $this->assertStringContainsString('email_from', $content);
            $this->assertStringContainsString('email_reply_to', $content);
            $this->assertStringContainsString('email_cc', $content);
            $this->assertStringContainsString('email_bcc', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains email2 configuration
     */
    public function test_widget_file_contains_email2_configuration()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('email2_to', $content);
            $this->assertStringContainsString('email2_subject', $content);
            $this->assertStringContainsString('email2_message', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains meta data options
     */
    public function test_widget_file_contains_meta_data_options()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('meta_data', $content);
            $this->assertStringContainsString('date', $content);
            $this->assertStringContainsString('time', $content);
            $this->assertStringContainsString('page_url', $content);
            $this->assertStringContainsString('user_agent', $content);
            $this->assertStringContainsString('remote_ip', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains redirect settings
     */
    public function test_widget_file_contains_redirect_settings()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            $this->assertStringContainsString('redirect_link', $content);
            $this->assertStringContainsString('redirect_url', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains form styling controls
     */
    public function test_widget_file_contains_form_styling_controls()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('section_form_style', $content);
            $this->assertStringContainsString('column_gap', $content);
            $this->assertStringContainsString('row_gap', $content);
            $this->assertStringContainsString('label_spacing', $content);
            $this->assertStringContainsString('label_color', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains field styling controls
     */
    public function test_widget_file_contains_field_styling_controls()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('section_field_style', $content);
            $this->assertStringContainsString('field_text_color', $content);
            $this->assertStringContainsString('field_background_color', $content);
            $this->assertStringContainsString('field_border_color', $content);
            $this->assertStringContainsString('field_border_width', $content);
            $this->assertStringContainsString('field_border_radius', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains button styling controls
     */
    public function test_widget_file_contains_button_styling_controls()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('section_button_style', $content);
            $this->assertStringContainsString('button_align', $content);
            $this->assertStringContainsString('button_typography', $content);
            $this->assertStringContainsString('button_background_color', $content);
            $this->assertStringContainsString('button_text_color', $content);
            $this->assertStringContainsString('button_border_color', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains button settings
     */
    public function test_widget_file_contains_button_settings()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('button_text', $content);
            $this->assertStringContainsString('button_size', $content);
            $this->assertStringContainsString('button_width', $content);
            $this->assertStringContainsString('selected_button_icon', $content);
            $this->assertStringContainsString('button_icon_align', $content);
            $this->assertStringContainsString('button_css_id', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains label settings
     */
    public function test_widget_file_contains_label_settings()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('show_labels', $content);
            $this->assertStringContainsString('mark_required', $content);
            $this->assertStringContainsString('label_position', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains input size options
     */
    public function test_widget_file_contains_input_size_options()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('input_size', $content);
            $this->assertStringContainsString('Extra Small', $content);
            $this->assertStringContainsString('Small', $content);
            $this->assertStringContainsString('Medium', $content);
            $this->assertStringContainsString('Large', $content);
            $this->assertStringContainsString('Extra Large', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains field controls
     */
    public function test_widget_file_contains_field_controls()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('field_type', $content);
            $this->assertStringContainsString('field_label', $content);
            $this->assertStringContainsString('placeholder', $content);
            $this->assertStringContainsString('required', $content);
            $this->assertStringContainsString('field_options', $content);
            $this->assertStringContainsString('field_value', $content);
            $this->assertStringContainsString('custom_id', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains advanced field controls
     */
    public function test_widget_file_contains_advanced_field_controls()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('allow_multiple', $content);
            $this->assertStringContainsString('select_size', $content);
            $this->assertStringContainsString('inline_list', $content);
            $this->assertStringContainsString('field_html', $content);
            $this->assertStringContainsString('width', $content);
            $this->assertStringContainsString('rows', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains AJAX submission handling
     */
    public function test_widget_file_contains_ajax_submission()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('dynamic_form_submit', $content);
            $this->assertStringContainsString('oom_form_submit_action', $content);
            $this->assertStringContainsString('admin-ajax.php', $content);
            $this->assertStringContainsString('$.ajax', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains form validation
     */
    public function test_widget_file_contains_form_validation()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('isValidNumber', $content);
            $this->assertStringContainsString('field-error', $content);
            $this->assertStringContainsString('validateOomAddOns', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains phone field handling
     */
    public function test_widget_file_contains_phone_field_handling()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('intlTelInput', $content);
            $this->assertStringContainsString('oom-phone', $content);
            $this->assertStringContainsString('tel', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains repeater usage
     */
    public function test_widget_file_contains_repeater_usage()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('new \Elementor\Repeater()', $content);
            $this->assertStringContainsString('form_fields', $content);
            $this->assertStringContainsString('get_controls', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains form name control
     */
    public function test_widget_file_contains_form_name_control()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('form_name', $content);
            $this->assertStringContainsString('Form Name', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file renders form markup
     */
    public function test_widget_file_renders_form_markup()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('oom-form-widget', $content);
            $this->assertStringContainsString('oom-custom-form', $content);
            $this->assertStringContainsString('elementor-form', $content);
            $this->assertStringContainsString('form_id', $content);
            $this->assertStringContainsString('post_id', $content);
            $this->assertStringContainsString('page_id', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file renders different input types
     */
    public function test_widget_file_renders_input_types()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('case \'text\':', $content);
            $this->assertStringContainsString('case \'email\':', $content);
            $this->assertStringContainsString('case \'textarea\':', $content);
            $this->assertStringContainsString('case \'select\':', $content);
            $this->assertStringContainsString('case \'radio\':', $content);
            $this->assertStringContainsString('case \'checkbox\':', $content);
            $this->assertStringContainsString('case \'html\':', $content);
            $this->assertStringContainsString('case \'hidden\':', $content);
            $this->assertStringContainsString('case \'acceptance\':', $content);
            $this->assertStringContainsString('case \'tel\':', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains option parsing for select/radio/checkbox
     */
    public function test_widget_file_parses_field_options()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('explode("\n", $field[\'field_options\'])', $content);
            $this->assertStringContainsString('strpos( $option, \'|\'', $content);
            $this->assertStringContainsString('list( $label, $value )', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains loading spinner
     */
    public function test_widget_file_contains_loading_spinner()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('loading-spinner', $content);
            $this->assertStringContainsString('form-message', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains JavaScript initialization
     */
    public function test_widget_file_contains_javascript_initialization()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('jQuery(document).ready', $content);
            $this->assertStringContainsString('const formId', $content);
            $this->assertStringContainsString('const formSelector', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains postal code validation
     */
    public function test_widget_file_contains_postal_code_validation()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('postcode', $content);
            $this->assertStringContainsString('post_code', $content);
            $this->assertStringContainsString('/^\d{6}$/', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains vehicle category handling
     */
    public function test_widget_file_contains_vehicle_category_handling()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('c_vehicle_category', $content);
            $this->assertStringContainsString('clearVehicleCategoryError', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains honeypot field
     */
    public function test_widget_file_contains_honeypot_field()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('oom_form', $content);
            $this->assertStringContainsString('display:none', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget file contains CSS styling
     */
    public function test_widget_file_contains_css_styling()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('<style>', $content);
            $this->assertStringContainsString('.field-error', $content);
            $this->assertStringContainsString('border-color', $content);
            $this->assertStringContainsString('box-shadow', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget renders button with icon support
     */
    public function test_widget_renders_button_with_icon_support()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('button-icon', $content);
            $this->assertStringContainsString('icon-wrapper', $content);
            $this->assertStringContainsString('Icons_Manager::render_icon', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget contains default field values
     */
    public function test_widget_contains_default_field_values()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('Name', $content);
            $this->assertStringContainsString('Email', $content);
            $this->assertStringContainsString('Message', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget has proper class inheritance
     */
    public function test_widget_extends_widget_base()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('extends \Elementor\Widget_Base', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test widget registration with Elementor
     */
    public function test_widget_registers_with_elementor()
    {
        $file = __DIR__ . '/../../hello-elementor-child/oom/widgets/oom-elementor-form/widgets/oom-form/oom-form.php';
        if (file_exists($file)) {
            $content = file_get_contents($file);
            
            $this->assertStringContainsString('\Elementor\Plugin::instance()->widgets_manager->register_widget_type', $content);
        } else {
            $this->markTestSkipped('Widget file not found');
        }
    }

    /**
     * Test _register_controls method executes
     */
    public function test_register_controls_executes()
    {
        $widget = $this->loadWidget();
        if ($widget && method_exists($widget, '_register_controls')) {
            ob_start();
            $widget->_register_controls();
            $output = ob_get_clean();
            
            // Method should execute without errors
            $this->assertTrue(true);
        } else {
            $this->markTestSkipped('Widget or method not available');
        }
    }

    /**
     * Test render method with default settings
     */
    public function test_render_with_default_settings()
    {
        $widget = $this->loadWidget();
        if ($widget && method_exists($widget, 'render')) {
            $settings = [
                'form_name' => 'Test Form',
                'show_labels' => 'true',
                'mark_required' => 'false',
                'label_position' => 'above',
                'input_size' => 'sm',
                'button_text' => 'Submit',
                'button_size' => 'sm',
                'button_width' => '100',
                'form_fields' => [
                    [
                        'custom_id' => 'name',
                        'field_type' => 'text',
                        'field_label' => 'Name',
                        'placeholder' => 'Enter your name',
                        'width' => '100',
                        'required' => 'true',
                    ]
                ]
            ];
            
            $widget->set_settings($settings);
            
            ob_start();
            $this->invokeMethod($widget, 'render');
            $output = ob_get_clean();
            
            $this->assertStringContainsString('oom-form-widget', $output);
            $this->assertStringContainsString('Test Form', $output);
            $this->assertStringContainsString('type="text"', $output);
        } else {
            $this->markTestSkipped('Widget or method not available');
        }
    }

    /**
     * Test render with email field
     */
    public function test_render_with_email_field()
    {
        $widget = $this->loadWidget();
        if ($widget && method_exists($widget, 'render')) {
            $settings = [
                'form_name' => 'Contact Form',
                'show_labels' => 'true',
                'input_size' => 'md',
                'button_text' => 'Send',
                'form_fields' => [
                    [
                        'custom_id' => 'email',
                        'field_type' => 'email',
                        'field_label' => 'Email',
                        'placeholder' => 'your@email.com',
                        'width' => '100',
                        'required' => 'true',
                    ]
                ]
            ];
            
            $widget->set_settings($settings);
            
            ob_start();
            $widget->render();
            $output = ob_get_clean();
            
            $this->assertStringContainsString('type="email"', $output);
            $this->assertStringContainsString('Email', $output);
        } else {
            $this->markTestSkipped('Widget or method not available');
        }
    }

    /**
     * Test render with textarea field
     */
    public function test_render_with_textarea_field()
    {
        $widget = $this->loadWidget();
        if ($widget && method_exists($widget, 'render')) {
            $settings = [
                'form_name' => 'Message Form',
                'show_labels' => 'true',
                'input_size' => 'lg',
                'button_text' => 'Submit',
                'form_fields' => [
                    [
                        'custom_id' => 'message',
                        'field_type' => 'textarea',
                        'field_label' => 'Message',
                        'placeholder' => 'Your message',
                        'width' => '100',
                        'rows' => 5,
                        'required' => 'false',
                    ]
                ]
            ];
            
            $widget->set_settings($settings);
            
            ob_start();
            $widget->render();
            $output = ob_get_clean();
            
            $this->assertStringContainsString('<textarea', $output);
            $this->assertStringContainsString('Message', $output);
        } else {
            $this->markTestSkipped('Widget or method not available');
        }
    }

    /**
     * Test render with select field
     */
    public function test_render_with_select_field()
    {
        $widget = $this->loadWidget();
        if ($widget && method_exists($widget, 'render')) {
            $settings = [
                'form_name' => 'Survey Form',
                'show_labels' => 'true',
                'input_size' => 'sm',
                'button_text' => 'Submit',
                'form_fields' => [
                    [
                        'custom_id' => 'choice',
                        'field_type' => 'select',
                        'field_label' => 'Choose One',
                        'width' => '100',
                        'field_options' => "Option 1|opt1\nOption 2|opt2\nOption 3|opt3",
                        'allow_multiple' => 'false',
                    ]
                ]
            ];
            
            $widget->set_settings($settings);
            
            ob_start();
            $widget->render();
            $output = ob_get_clean();
            
            $this->assertStringContainsString('<select', $output);
            $this->assertStringContainsString('Option 1', $output);
            $this->assertStringContainsString('opt1', $output);
        } else {
            $this->markTestSkipped('Widget or method not available');
        }
    }

    /**
     * Test render with radio buttons
     */
    public function test_render_with_radio_buttons()
    {
        $widget = $this->loadWidget();
        if ($widget && method_exists($widget, 'render')) {
            $settings = [
                'form_name' => 'Choice Form',
                'show_labels' => 'true',
                'input_size' => 'sm',
                'button_text' => 'Submit',
                'form_fields' => [
                    [
                        'custom_id' => 'gender',
                        'field_type' => 'radio',
                        'field_label' => 'Gender',
                        'width' => '100',
                        'field_options' => "Male|male\nFemale|female\nOther|other",
                        'inline_list' => 'elementor-subgroup-inline',
                    ]
                ]
            ];
            
            $widget->set_settings($settings);
            
            ob_start();
            $widget->render();
            $output = ob_get_clean();
            
            $this->assertStringContainsString('type="radio"', $output);
            $this->assertStringContainsString('Male', $output);
            $this->assertStringContainsString('Female', $output);
        } else {
            $this->markTestSkipped('Widget or method not available');
        }
    }

    /**
     * Test render with checkbox field
     */
    public function test_render_with_checkbox_field()
    {
        $widget = $this->loadWidget();
        if ($widget && method_exists($widget, 'render')) {
            $settings = [
                'form_name' => 'Preferences Form',
                'show_labels' => 'true',
                'input_size' => 'sm',
                'button_text' => 'Submit',
                'form_fields' => [
                    [
                        'custom_id' => 'interests',
                        'field_type' => 'checkbox',
                        'field_label' => 'Interests',
                        'width' => '100',
                        'field_options' => "Sports|sports\nMusic|music\nReading|reading",
                        'inline_list' => '',
                    ]
                ]
            ];
            
            $widget->set_settings($settings);
            
            ob_start();
            $widget->render();
            $output = ob_get_clean();
            
            $this->assertStringContainsString('type="checkbox"', $output);
            $this->assertStringContainsString('Sports', $output);
        } else {
            $this->markTestSkipped('Widget or method not available');
        }
    }

    /**
     * Test render with acceptance field
     */
    public function test_render_with_acceptance_field()
    {
        $widget = $this->loadWidget();
        if ($widget && method_exists($widget, 'render')) {
            $settings = [
                'form_name' => 'Agreement Form',
                'show_labels' => 'true',
                'input_size' => 'sm',
                'button_text' => 'Accept',
                'form_fields' => [
                    [
                        'custom_id' => 'terms',
                        'field_type' => 'acceptance',
                        'field_label' => 'Terms',
                        'width' => '100',
                        'field_html' => 'I agree to the terms and conditions',
                        'required' => 'true',
                    ]
                ]
            ];
            
            $widget->set_settings($settings);
            
            ob_start();
            $widget->render();
            $output = ob_get_clean();
            
            $this->assertStringContainsString('type="checkbox"', $output);
            $this->assertStringContainsString('I agree to the terms', $output);
        } else {
            $this->markTestSkipped('Widget or method not available');
        }
    }

    /**
     * Test render with hidden field
     */
    public function test_render_with_hidden_field()
    {
        $widget = $this->loadWidget();
        if ($widget && method_exists($widget, 'render')) {
            $settings = [
                'form_name' => 'Hidden Form',
                'show_labels' => 'true',
                'input_size' => 'sm',
                'button_text' => 'Submit',
                'form_fields' => [
                    [
                        'custom_id' => 'token',
                        'field_type' => 'hidden',
                        'field_value' => 'abc123',
                    ]
                ]
            ];
            
            $widget->set_settings($settings);
            
            ob_start();
            $widget->render();
            $output = ob_get_clean();
            
            $this->assertStringContainsString('type="hidden"', $output);
            $this->assertStringContainsString('abc123', $output);
        } else {
            $this->markTestSkipped('Widget or method not available');
        }
    }

    /**
     * Test render with HTML field
     */
    public function test_render_with_html_field()
    {
        $widget = $this->loadWidget();
        if ($widget && method_exists($widget, 'render')) {
            $settings = [
                'form_name' => 'Info Form',
                'show_labels' => 'true',
                'input_size' => 'sm',
                'button_text' => 'Submit',
                'form_fields' => [
                    [
                        'custom_id' => 'info',
                        'field_type' => 'html',
                        'width' => '100',
                        'field_html' => '<p>This is some custom HTML</p>',
                    ]
                ]
            ];
            
            $widget->set_settings($settings);
            
            ob_start();
            $widget->render();
            $output = ob_get_clean();
            
            $this->assertStringContainsString('This is some custom HTML', $output);
        } else {
            $this->markTestSkipped('Widget or method not available');
        }
    }

    /**
     * Test render with tel field
     */
    public function test_render_with_tel_field()
    {
        $widget = $this->loadWidget();
        if ($widget && method_exists($widget, 'render')) {
            $settings = [
                'form_name' => 'Phone Form',
                'show_labels' => 'true',
                'input_size' => 'sm',
                'button_text' => 'Submit',
                'form_fields' => [
                    [
                        'custom_id' => 'phone',
                        'field_type' => 'tel',
                        'field_label' => 'Phone',
                        'placeholder' => '1234 5678',
                        'width' => '100',
                        'required' => 'true',
                    ]
                ]
            ];
            
            $widget->set_settings($settings);
            
            ob_start();
            $widget->render();
            $output = ob_get_clean();
            
            $this->assertStringContainsString('type="tel"', $output);
            $this->assertStringContainsString('oom-phone', $output);
        } else {
            $this->markTestSkipped('Widget or method not available');
        }
    }

    /**
     * Test render with multiple fields
     */
    public function test_render_with_multiple_fields()
    {
        $widget = $this->loadWidget();
        if ($widget && method_exists($widget, 'render')) {
            $settings = [
                'form_name' => 'Complete Form',
                'show_labels' => 'true',
                'mark_required' => 'true',
                'input_size' => 'sm',
                'button_text' => 'Send Message',
                'button_size' => 'md',
                'form_fields' => [
                    [
                        'custom_id' => 'name',
                        'field_type' => 'text',
                        'field_label' => 'Full Name',
                        'placeholder' => 'John Doe',
                        'width' => '50',
                        'required' => 'true',
                    ],
                    [
                        'custom_id' => 'email',
                        'field_type' => 'email',
                        'field_label' => 'Email Address',
                        'placeholder' => 'john@example.com',
                        'width' => '50',
                        'required' => 'true',
                    ],
                    [
                        'custom_id' => 'message',
                        'field_type' => 'textarea',
                        'field_label' => 'Message',
                        'placeholder' => 'Your message here...',
                        'width' => '100',
                        'rows' => 4,
                        'required' => 'true',
                    ]
                ]
            ];
            
            $widget->set_settings($settings);
            
            ob_start();
            $widget->render();
            $output = ob_get_clean();
            
            $this->assertStringContainsString('Full Name', $output);
            $this->assertStringContainsString('Email Address', $output);
            $this->assertStringContainsString('Message', $output);
            $this->assertStringContainsString('type="text"', $output);
            $this->assertStringContainsString('type="email"', $output);
            $this->assertStringContainsString('<textarea', $output);
        } else {
            $this->markTestSkipped('Widget or method not available');
        }
    }

    /**
     * Test render with number field
     */
    public function test_render_with_number_field()
    {
        $widget = $this->loadWidget();
        if ($widget && method_exists($widget, 'render')) {
            $settings = [
                'form_name' => 'Number Form',
                'show_labels' => 'true',
                'input_size' => 'sm',
                'button_text' => 'Submit',
                'form_fields' => [
                    [
                        'custom_id' => 'age',
                        'field_type' => 'number',
                        'field_label' => 'Age',
                        'placeholder' => '25',
                        'width' => '100',
                    ]
                ]
            ];
            
            $widget->set_settings($settings);
            
            ob_start();
            $widget->render();
            $output = ob_get_clean();
            
            $this->assertStringContainsString('type="number"', $output);
        } else {
            $this->markTestSkipped('Widget or method not available');
        }
    }

    /**
     * Test render with date field
     */
    public function test_render_with_date_field()
    {
        $widget = $this->loadWidget();
        if ($widget && method_exists($widget, 'render')) {
            $settings = [
                'form_name' => 'Date Form',
                'show_labels' => 'true',
                'input_size' => 'sm',
                'button_text' => 'Submit',
                'form_fields' => [
                    [
                        'custom_id' => 'birthdate',
                        'field_type' => 'date',
                        'field_label' => 'Birth Date',
                        'width' => '100',
                    ]
                ]
            ];
            
            $widget->set_settings($settings);
            
            ob_start();
            $widget->render();
            $output = ob_get_clean();
            
            $this->assertStringContainsString('type="date"', $output);
        } else {
            $this->markTestSkipped('Widget or method not available');
        }
    }

    /**
     * Test render with time field
     */
    public function test_render_with_time_field()
    {
        $widget = $this->loadWidget();
        if ($widget && method_exists($widget, 'render')) {
            $settings = [
                'form_name' => 'Time Form',
                'show_labels' => 'true',
                'input_size' => 'sm',
                'button_text' => 'Submit',
                'form_fields' => [
                    [
                        'custom_id' => 'appointment',
                        'field_type' => 'time',
                        'field_label' => 'Appointment Time',
                        'width' => '100',
                    ]
                ]
            ];
            
            $widget->set_settings($settings);
            
            ob_start();
            $widget->render();
            $output = ob_get_clean();
            
            $this->assertStringContainsString('type="time"', $output);
        } else {
            $this->markTestSkipped('Widget or method not available');
        }
    }

    /**
     * Test render with password field
     */
    public function test_render_with_password_field()
    {
        $widget = $this->loadWidget();
        if ($widget && method_exists($widget, 'render')) {
            $settings = [
                'form_name' => 'Login Form',
                'show_labels' => 'true',
                'input_size' => 'sm',
                'button_text' => 'Login',
                'form_fields' => [
                    [
                        'custom_id' => 'password',
                        'field_type' => 'password',
                        'field_label' => 'Password',
                        'placeholder' => 'Enter password',
                        'width' => '100',
                        'required' => 'true',
                    ]
                ]
            ];
            
            $widget->set_settings($settings);
            
            ob_start();
            $widget->render();
            $output = ob_get_clean();
            
            $this->assertStringContainsString('type="password"', $output);
        } else {
            $this->markTestSkipped('Widget or method not available');
        }
    }

    /**
     * Test render with URL field
     */
    public function test_render_with_url_field()
    {
        $widget = $this->loadWidget();
        if ($widget && method_exists($widget, 'render')) {
            $settings = [
                'form_name' => 'URL Form',
                'show_labels' => 'true',
                'input_size' => 'sm',
                'button_text' => 'Submit',
                'form_fields' => [
                    [
                        'custom_id' => 'website',
                        'field_type' => 'url',
                        'field_label' => 'Website',
                        'placeholder' => 'https://example.com',
                        'width' => '100',
                    ]
                ]
            ];
            
            $widget->set_settings($settings);
            
            ob_start();
            $widget->render();
            $output = ob_get_clean();
            
            $this->assertStringContainsString('type="url"', $output);
        } else {
            $this->markTestSkipped('Widget or method not available');
        }
    }

    /**
     * Test render includes JavaScript
     */
    public function test_render_includes_javascript()
    {
        $widget = $this->loadWidget();
        if ($widget && method_exists($widget, 'render')) {
            $settings = [
                'form_name' => 'Test Form',
                'show_labels' => 'true',
                'input_size' => 'sm',
                'button_text' => 'Submit',
                'form_fields' => []
            ];
            
            $widget->set_settings($settings);
            
            ob_start();
            $widget->render();
            $output = ob_get_clean();
            
            $this->assertStringContainsString('<script>', $output);
            $this->assertStringContainsString('jQuery(document).ready', $output);
            $this->assertStringContainsString('$.ajax', $output);
        } else {
            $this->markTestSkipped('Widget or method not available');
        }
    }

    /**
     * Test render includes CSS
     */
    public function test_render_includes_css()
    {
        $widget = $this->loadWidget();
        if ($widget && method_exists($widget, 'render')) {
            $settings = [
                'form_name' => 'Test Form',
                'show_labels' => 'true',
                'input_size' => 'sm',
                'button_text' => 'Submit',
                'form_fields' => []
            ];
            
            $widget->set_settings($settings);
            
            ob_start();
            $widget->render();
            $output = ob_get_clean();
            
            $this->assertStringContainsString('<style>', $output);
            $this->assertStringContainsString('.field-error', $output);
        } else {
            $this->markTestSkipped('Widget or method not available');
        }
    }

    /**
     * Test render with button icon
     */
    public function test_render_with_button_icon()
    {
        $widget = $this->loadWidget();
        if ($widget && method_exists($widget, 'render')) {
            $settings = [
                'form_name' => 'Icon Form',
                'show_labels' => 'true',
                'input_size' => 'sm',
                'button_text' => 'Submit',
                'selected_button_icon' => ['value' => 'fas fa-check'],
                'form_fields' => []
            ];
            
            $widget->set_settings($settings);
            
            ob_start();
            $widget->render();
            $output = ob_get_clean();
            
            $this->assertStringContainsString('button-icon', $output);
        } else {
            $this->markTestSkipped('Widget or method not available');
        }
    }

    /**
     * Test render without labels
     */
    public function test_render_without_labels()
    {
        $widget = $this->loadWidget();
        if ($widget && method_exists($widget, 'render')) {
            $settings = [
                'form_name' => 'No Labels Form',
                'show_labels' => 'false',
                'input_size' => 'sm',
                'button_text' => 'Submit',
                'form_fields' => [
                    [
                        'custom_id' => 'name',
                        'field_type' => 'text',
                        'field_label' => 'Name',
                        'placeholder' => 'Your name',
                        'width' => '100',
                    ]
                ]
            ];
            
            $widget->set_settings($settings);
            
            ob_start();
            $widget->render();
            $output = ob_get_clean();
            
            $this->assertStringContainsString('type="text"', $output);
            // Label should not be rendered when show_labels is false
            $this->assertStringNotContainsString('<label', $output);
        } else {
            $this->markTestSkipped('Widget or method not available');
        }
    }
}

